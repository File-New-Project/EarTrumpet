name: EarTrumpet-CI
on:
  push:
    branches:
      - master
      - dev
      - rafael/*
      - dave/*
      - david/*
    paths-ignore:
      - "**/*.md"
      - ".github/ISSUE_TEMPLATE/*"
      - ".github/workflows/sponsors.yml"
      - "Graphics/*"
  pull_request:
    branches:
      - dev
    paths-ignore:
      - "**/*.md"
      - crowdin.yml
env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x86
  ARTIFACTS_BASE: '${{ github.workspace }}\artifacts'

jobs:
  test:
    runs-on: windows-2019
    env:
      AZURE_TENANT_ID: ${{ secrets.azure_tenant_id }}
      AZURE_CLIENT_ID: ${{ secrets.azure_client_id }}
      AZURE_CLIENT_SECRET: ${{ secrets.azure_client_secret }}
    steps:
      - name: Install Build Tools
        run: nuget install Microsoft.Windows.SDK.BuildTools

      - name: Install Azure Codesigning
        shell: pwsh
        env:
          ACS_PACKAGE_URI: ${{ secrets.acs_package_uri }}
          ACS_METADATA_URI: ${{ secrets.acs_metadata_uri }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          Invoke-WebRequest $env:ACS_PACKAGE_URI -UseBasicParsing -OutFile package.zip
          Expand-Archive package.zip -DestinationPath acs
          Invoke-WebRequest $env:ACS_METADATA_URI -UseBasicParsing -OutFile acs\metadata.json

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Test
        shell: pwsh
        run: |
          (Resolve-Path "Microsoft.Windows.SDK.BuildTools.*\bin\*\x64\signtool.exe")
          & (Resolve-Path "Microsoft.Windows.SDK.BuildTools.*\bin\*\x64\signtool.exe") sign /debug /v /fd SHA256 /td SHA256 /dlib "acs\bin\x64\Azure.CodeSigning.Dlib.dll" /dmdf "acs\metadata.json" (Resolve-Path "Microsoft.Windows.SDK.BuildTools.*\bin\*\x64\midl.exe")
